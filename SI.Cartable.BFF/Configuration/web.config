<?xml version="1.0" encoding="utf-8"?>
<configuration>
	<system.webServer>
		<handlers>
			<add name="iisnode" path=".next/standalone/server.js" verb="*" modules="iisnode" />
		</handlers>

		<rewrite>
			<rules>
				<!-- جلوگیری از دسترسی مستقیم -->
				<rule name="BlockServerJS" stopProcessing="true">
					<match url="^.next/standalone/server\.js$" />
					<action type="CustomResponse" statusCode="403" />
				</rule>

				<!-- Service Worker -->
				<rule name="ServiceWorker" stopProcessing="true">
					<match url="^(sw\.js|workbox-.+\.js)$" />
					<action type="Rewrite" url="public/{R:1}" />
				</rule>

				<!-- Manifest -->
				<rule name="Manifest" stopProcessing="true">
					<match url="^manifest\.json$" />
					<action type="Rewrite" url="public/manifest.json" />
				</rule>

				<!-- Static files -->
				<rule name="StaticFiles" stopProcessing="true">
					<match url="^(.+\.(ico|png|jpg|jpeg|gif|svg|css|js|json|webmanifest|woff|woff2|ttf|eot))$" />
					<conditions>
						<add input="{REQUEST_FILENAME}" matchType="IsFile" />
					</conditions>
					<action type="None" />
				</rule>

				<!-- Next.js static -->
				<rule name="NextStatic" stopProcessing="true">
					<match url="^_next/(.*)$" />
					<action type="Rewrite" url="_next/{R:1}" />
				</rule>

				<!-- Dynamic content -->
				<rule name="NodeApp">
					<match url=".*" />
					<conditions>
						<add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
					</conditions>
					<action type="Rewrite" url=".next/standalone/server.js" />
				</rule>
			</rules>
		</rewrite>

		<!-- Security Headers -->
		<httpProtocol>
			<customHeaders>
				<clear />
				<add name="X-Content-Type-Options" value="nosniff" />
				<add name="X-Frame-Options" value="DENY" />
				<add name="X-XSS-Protection" value="1; mode=block" />
				<add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
				<add name="Permissions-Policy" value="camera=(), microphone=(), geolocation=()" />
			</customHeaders>
		</httpProtocol>

		<httpErrors existingResponse="PassThrough" />

		<urlCompression doStaticCompression="true" doDynamicCompression="true" />

		<!-- MIME Types برای PWA -->
		<staticContent>
			<mimeMap fileExtension=".webmanifest" mimeType="application/manifest+json" />
			<mimeMap fileExtension=".json" mimeType="application/json" />
			<clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="00:00:00" />
		</staticContent>
	</system.webServer>
</configuration>